var app=angular.module("directive-factory",['service-factory']);app.directive("weIcon",function(){return{scope:{icon:'@',size:'@',title:'@',class:'@'},templateUrl:"we-icon.html",controller:["$scope","$element","$utils",function($scope,$element,$utils){$scope.iconFamily=$scope.icon.split(":")[0];$scope.iconName=$scope.icon.split(":")[1].split('_').join('-');$element.find("use").attr("xlink:href",$utils.getServerUrl()+"/ng-slds/resource/slds/assets/icons/"+$scope.iconFamily+"-sprite/svg/symbols.svg#"+$scope.icon.split(":")[1]);}]};});app.directive("weSpinner",function(){return{templateUrl:"we-spinner.html"}});app.directive("weToaster",function(){return{scope:{type:'@',messege:'@'},templateUrl:"we-toaster.html",controller:["$scope","$element",function($scope,$element){$scope.removeTime;$scope.init=function(){switch($scope.type){case'info':$scope.removeTime=5000;break;case'success':$scope.removeTime=5000;break;case'warning':$scope.removeTime=10000;break;}
        if($scope.removeTime){setTimeout(function(){$scope.removeToaster();},$scope.removeTime);}}
        $scope.removeToaster=function(){$element.remove();}
        $scope.init();}]};});app.directive("weDropdown",function(){return{replace:true,scope:{selectedItem:'=',options:'=',label:'@',required:'@'},templateUrl:"we-dropdown.html"}})
app.directive("weFormValidator",function(){return{replace:true,transclude:true,scope:{formName:'='},templateUrl:"we-form-validator.html"}})
app.directive("weInputField",function(){return{replace:true,scope:{name:'@',label:'@',type:'@',value:'=',required:'@',options:'=?',valueField:'@',labelField:'@',form:'='},templateUrl:'we-input-field.html',controller:["$scope","$compile","$element",function($scope,$compile,$element){switch($scope.type){case"text":angular.element($element[0].querySelector('.slds-form-element__control')).append($compile('<we-input-text name="name" label="label" value="value" required="required"></we-input-text>')($scope));break;case"lookup":angular.element($element[0].querySelector('.slds-form-element__control')).append($compile('<we-input-lookup name="name" label="label" value="value" required="required" getoptions="getoptions(success,keyword)"></we-input-lookup>')($scope));break;}
        $scope.getoptions=function(success,keyword){if($scope.options&&Array.isArray($scope.options)){var options=$scope.getStructuredOptions($scope.options);if(keyword){var filteredOptions=options.filter(function(option){return option.label.includes(keyword);})
            success(filteredOptions);}else{success(options);}}else{success([]);}}
        $scope.getStructuredOptions=function(options){var options=[];for(var o in $scope.options){if(typeof($scope.options[o])=='string'){options.push({'label':$scope.labelField?$scope.options[o][$scope.labelField]:$scope.options[o],'value':$scope.valueField?$scope.options[o][$scope.valueField]:$scope.options[o]});}else{options.push({'label':$scope.options[o],'value':$scope.options[o]});}}
            return options;}}]}})
app.directive("weInputValidator",function(){return{replace:true,scope:{errors:'='},templateUrl:"we-input-validator.html"}})
app.directive("weInputText",function(){return{replace:true,scope:{name:'=',label:'=',value:'=',required:'='},templateUrl:"we-input-text.html"}})
app.directive("weToggleButton",function(){return{replace:true,scope:{label:'=',value:'='},templateUrl:"we-toggle.html",controller:['$scope',function($scope){$scope.toggleAction = function(isChecked){ $scope.value = isChecked;}}]}})
app.directive("weInputLookup",function(){return{replace:true,scope:{name:'=',label:'=',value:'=',required:'=',getoptions:'&'},templateUrl:"we-input-lookup.html",controller:["$scope",function($scope){$scope.onfocus=function(){$scope.getoptions({'success':function(options){$scope.options=options;$scope.show=true;$scope.$apply();},'keyword':$scope.keyword})}
        $scope.selectOption=function(option){$scope.keyword=option.label;$scope.value=option.value;}
        $scope.onblur=function(){setTimeout(function(){$scope.show=false;$scope.$apply();},100)}
        $scope.getLookupOptions=function(options){$scope.options=options;}}]}})
app.directive("weDraggableTable",function(){return{replace:true,scope:{data:'=',meta:'='},templateUrl:"we-draggable-table.html"}})
app.directive('weSchedular',function(){return{replace:true,scope:{generatedCron:'=',action:'=?'},templateUrl:'we-schedular.html',controller:['$scope',function($scope){$scope.WeekDays=[{Id:0,Name:'Sunday',Selected:false},{Id:1,Name:'Monday',Selected:false},{Id:2,Name:'Tuesday',Selected:false},{Id:3,Name:'Wednesday',Selected:false},{Id:4,Name:'Thursday',Selected:false},{Id:5,Name:'Friday',Selected:false},{Id:6,Name:'Saturday',Selected:false}];$scope.Days=[{Id:1,Selected:false},{Id:2,Selected:false},{Id:3,Selected:false},{Id:4,Selected:false},{Id:5,Selected:false},{Id:6,Selected:false},{Id:7,Selected:false},{Id:8,Selected:false},{Id:9,Selected:false},{Id:10,Selected:false},{Id:11,Selected:false},{Id:12,Selected:false},{Id:13,Selected:false},{Id:14,Selected:false},{Id:15,Selected:false},{Id:16,Selected:false},{Id:17,Selected:false},{Id:18,Selected:false},{Id:19,Selected:false},{Id:20,Selected:false},{Id:21,Selected:false},{Id:22,Selected:false},{Id:23,Selected:false},{Id:24,Selected:false},{Id:25,Selected:false},{Id:26,Selected:false},{Id:27,Selected:false},{Id:28,Selected:false},]
        $scope.Months=[{Id:1,Selected:false,Name:'January'},{Id:2,Selected:false,Name:'Februry'},{Id:3,Selected:false,Name:'March'},{Id:4,Selected:false,Name:'April'},{Id:5,Selected:false,Name:'May'},{Id:6,Selected:false,Name:'June'},{Id:7,Selected:false,Name:'July'},{Id:8,Selected:false,Name:'August'},{Id:9,Selected:false,Name:'September'},{Id:10,Selected:false,Name:'October'},{Id:11,Selected:false,Name:'November'},{Id:12,Selected:false,Name:'December'},]
        $scope.SelectedHour=[{Name:'perHour',Hour:1}];$scope.SelectedDays=[{Name:'everyDay',Value:''}];$scope.SelectedMonths=[{Name:'everyMonth',Value:''}];$scope.setHours=function(temp){$scope.SelectedHour[0].Name=temp;if(temp=='perHour')
            $scope.SelectedHour[0].Hour=1;else
            $scope.SelectedHour[0].Hour=document.getElementById(temp).value;};$scope.setHourFrequency=function(hourFrequency){$scope.SelectedHour[0].Hour=hourFrequency;};$scope.setDays=function(days){$scope.SelectedDays[0].Name=days;if(days=='everyday')
            $scope.SelectedDays[0].Value='*';else if(days=='specific_day_of_week')
            $scope.SelectedDays[0].Value=$scope.WeekDays;else if(days=='specific_day_of_month')
            $scope.SelectedDays[0].Value=$scope.Days;};$scope.setMonths=function(month){$scope.SelectedMonths[0].Name=month;if(month=='everyMonth')
            $scope.SelectedMonths[0].Value='*';else if(month=='specificMonth')
            $scope.SelectedMonths[0].Value=$scope.Months;};$scope.generateCron=function(){var min='H';var hr='*';var dom='*';var mon='*';var dow='*';if($scope.SelectedHour[0].Name=='perHour')
            hr='*';else if($scope.SelectedHour[0].Name=='specificHour1')
            hr='*/'.concat($scope.SelectedHour[0].Hour);else if($scope.SelectedHour[0].Name=='specificHour2')
            hr=$scope.SelectedHour[0].Hour;if($scope.SelectedDays[0].Name=='everyDay'){dom='*';dow='*';}
        else if($scope.SelectedDays[0].Name=='specific_day_of_week'){dow='';for(var item in $scope.SelectedDays[0].Value)
            if($scope.SelectedDays[0].Value[item]['Selected']==true)
                dow=dow.concat($scope.SelectedDays[0].Value[item]['Id']).concat(',');dow=dow.substr(0,dow.length-1);}else if($scope.SelectedDays[0].Name=='specific_day_of_month'){dom='';for(var item in $scope.SelectedDays[0].Value)
            if($scope.SelectedDays[0].Value[item]['Selected']==true)
                dom=dom.concat($scope.SelectedDays[0].Value[item]['Id']).concat(',');dom=dom.substr(0,dom.length-1);}
            if($scope.SelectedMonths[0].Name=='everyMonth'){mon='*';}
            else if($scope.SelectedMonths[0].Name=='specificMonth'){mon='';for(var item in $scope.SelectedMonths[0].Value)
                if($scope.SelectedMonths[0].Value[item]['Selected']==true)
                    mon=mon.concat($scope.SelectedMonths[0].Value[item]['Id']).concat(',');mon=mon.substr(0,mon.length-1);}
            $scope.generatedCron=min+' '+hr+' '+dom+' '+mon+' '+dow;};}]}})
app.directive('weDataTable',function(){return{replace:true,scope:{rows:'=',columns:'=',tableName:'@',show:'=?',identifier:'=?',record:'='},templateUrl:"we-data-table.html",controller:["$scope","$postgres",function($scope,$postgres){$scope.showForm=function(id){$scope.show='slds-fade-in-open slds-backdrop--open';$postgres.getRecord($scope.tableName,id).then(function(result){for(var res in result){$scope.record[res]=result[res];}});}
        $scope.delete=function(id){$postgres.deleteRecord($scope.tableName,id).then(function(result){$scope.rows=result;});}
        $scope.prompt='slds-slide-up-close slds-backdrop--close';}]}})
app.directive('weShowDataModal',function(){return{replace:true,scope:{id:'=?',table:'=?',action:'=?',template:'@',run:'&',schedule:'&'},templateUrl:"we-show-data.html",controller:["$scope","$postgres",function($scope,$postgres){$postgres.getRecord($scope.table,$scope.id).then(function(result){$scope.record=result;});}]}})
app.directive('weEditDataModal',function(){return{replace:true,scope:{data:'@',header:'@',action:'=?',table:'=?',id:'=?',record:'='},controller:["$scope","$postgres",function($scope,$postgres){$scope.insert=function(){$postgres.insertRecord($scope.table,$scope.record).then(function(){});}}]}})
app.directive('wePromptWarning',function(){return{replace:true,scope:{message:'@',header:'@',terminate:'=',actionToTake:'&',id:'=?'},templateUrl:"we-prompt-warning.html",controller:["$scope",function($scope){$scope.takeAction=function(){$scope.actionToTake({'id':$scope.id});}}]}})
app.directive('weInputCheckbox',function(){return{replace:true,scope:{name:'@',label:'@',grouped:'@',groupedItems:'=',selectedItems:'='},templateUrl:"we-input-checkbox.html",controller:["$scope","$element","$compile",function($scope,$element,$compile){if($scope.grouped){angular.element($element[0].querySelector('.slds-form-element__control')).append($compile('<span class="slds-form&#45;&#45;inline slds-checkbox">\n'+'        <span ng-repeat="item in groupedItems track by $index">\n'+'            <input type="checkbox" name="item.name" ng-click="addIntoSelected(item)"/>\n'+'            <label class="slds-checkbox__label slds-text-color&#45;&#45;default" for="">\n'+'                <span class="slds-checkbox&#45;&#45;faux"></span>\n'+'                <span class="slds-form-element__label slds-text-color&#45;&#45;default">{{item.label}}</span>\n'+'            </label>\n'+'    </span>')($scope))}
    else
        angular.element($element[0].querySelector('.slds-form-element__control')).append($compile('<label class="slds-checkbox__label">\n'+'<span class="slds-checkbox&#45;&#45;faux"></span>\n'+'<span class="slds-form-element__label slds-text-color&#45;&#45;default">{{label}}</span>\n'+'</label>\n'+'<input type="checkbox" ng-click="addSelectedOptions($event,\'Browser\')"/>')($scope))
        $scope.addIntoSelected=function(itemToAdd){if(selectedItems.indexOf(itemToAdd)<0)
            selectedItems.push(itemToAdd)}}]}})
app.directive("weSidebar",function(){return{replace:true,scope:{nodes:'='},templateUrl:"we-sidebar.html"}});app.directive('weModalForm',function(){return{template:"test"}});app.directive('weLookupList',function(){return{replace:true,scope:{nodes:'=',pills:'=',fields:'=?',addNode:'&',action:'=?'},templateUrl:"we-lookup-list.html",controller:["$scope","$element","$rootScope",function($scope,$element,$rootScope){$scope.addNode=function(node){$scope.pills.push(node);$scope.nodes.splice($scope.nodes.indexOf(node),1);$scope.action='slds-is-close';}}]}});app.directive("weDraggableTree",function(){return{replace:true,scope:{data:'=',expanded:"@",parent:'@',depth:'@'},templateUrl:"we-draggable-tree.html",controller:["$scope","$element","$rootScope",function($scope,$element,$rootScope){$scope.mapExpandedNode={};$scope.init=function(){if(!$scope.parent){$scope.parent='';}
        if(!$scope.depth){$scope.depth=1;}else{$scope.depth=parseInt($scope.depth);}
        angular.forEach($scope.data,function(node){node.uniqueId=$scope.generateUniqueId();})}
        $scope.generateUniqueId=function(){return Math.floor((Math.random()*99999)+1);}
        $scope.nodeClick=function(nodeId){$scope.mapExpandedNode[nodeId]=$scope.mapExpandedNode[nodeId]?false:true;}
        $scope.drag=function(event){event.dataTransfer.setData("text",event.target.id);}
        $scope.allowDrop=function(event){if($(event.currentTarget).find('ul.active').length==0){$($(event.currentTarget).parent()).find('ul[data-depth='+event.currentTarget.dataset.depth+']').addClass('active');}
            event.preventDefault();}
        $scope.dragLeave=function(event){$(event.currentTarget).last().removeClass('active');}
        $scope.drop=function(event){event.preventDefault();if($element.find("ul").first().hasClass('active')&&!$rootScope.targetId){var dropid=event.dataTransfer.getData("text");var parentid=document.getElementById(dropid).getAttribute('data-parent');if(!$scope.data){$scope.data=[];}
            var index=$scope.data.findIndex(function(data){return data.uniqueId==dropid;})
            if($('#'+dropid).find('ul[data-parent='+event.currentTarget.dataset.parent+']').length==0&&index==-1){$rootScope.targetId=parentid;console.log(dropid);var record=JSON.parse(document.getElementById(dropid).getAttribute('data-record'));console.log(record);$scope.data.push(record);$element.find('ul').removeClass('active');$scope.$apply();window.postMessage(parentid+':'+dropid,location.origin);}else{$element.find('ul').removeClass('active');}}}
        window.addEventListener("message",function(event){var parentId=event.data.split(":")[0];var childId=event.data.split(":")[1]
            if($scope.parent==parentId){for(var node in $scope.data){if($scope.data[node].uniqueId==childId){$scope.data.splice(parseInt(node),1);$rootScope.targetId=undefined;$scope.$apply();}}}},false);$scope.init();}]}})